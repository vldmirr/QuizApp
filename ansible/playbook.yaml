---
- name: Deploy FastAPI application
  hosts: all
  become: yes
  vars:
    app_port: 8000
    app_name: fastapi-cloud-project
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        
    - name: Install Docker
      apt:
        name: docker.io
        state: present
        
    - name: Install Docker Compose
      apt:
        name: docker-compose
        state: present
        
    - name: Create application directory
      file:
        path: "/opt/{{ app_name }}"
        state: directory
        
    - name: Copy application files
      copy:
        src: "../"
        dest: "/opt/{{ app_name }}"
        
    - name: Build and run with Docker Compose
      command: docker-compose up -d
      args:
        chdir: "/opt/{{ app_name }}"
        
    - name: Ensure application is running
      wait_for:
        port: "{{ app_port }}"
        host: localhost
        timeout: 60